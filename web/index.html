<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="StopAddict - Compteur personnel antid√©pendance">
  <meta name="theme-color" content="#1e293b">
  <title>StopAddict v3 - Complet</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:">
  <style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --primary: #1e293b;
  --primary-dark: #0f172a;
  --primary-light: #334155;
  --accent-green: #10b981;
  --accent-orange: #f97316;
  --accent-blue: #3b82f6;
  --text-main: #1f2937;
  --text-muted: #6b7280;
  --bg-light: #f9fafb;
  --border-light: #e5e7eb;
}

html, body { font-family: system-ui, -apple-system, Segoe UI, Roboto; background: #fff; color: var(--text-main); line-height: 1.5; }
body { padding-bottom: 80px; }

.app-shell { width: 100%; max-width: 480px; margin: 0 auto; background: #fff; }

/* HEADER */
.hdr { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: #fff; padding: 16px 12px; text-align: center; position: sticky; top: 0; z-index: 40; }
.hdr .title { font-size: 18px; font-weight: 900; margin: 0; }
.hdr .subtitle { font-size: 12px; opacity: 0.8; margin: 4px 0 0; }

/* √âCRANS */
.ecran { display: none; animation: fadeIn 0.2s; }
.ecran.show { display: block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* CARTES */
.card { background: #fff; border: 1px solid var(--border-light); border-radius: 12px; padding: 14px; margin: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.card.bar-green { border-left: 4px solid var(--accent-green); }

/* BANDEAUX */
.banner { border-radius: 12px; padding: 12px; margin: 8px; }
.banner.green { background: #ecfdf5; border-left: 4px solid var(--accent-green); }
.banner.orange { background: #fff7ed; border-left: 4px solid var(--accent-orange); }

/* ROW */
.row { display: flex; justify-content: space-between; align-items: center; }
.row-slim { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 14px; }
.row-slim .label { flex: 1; font-weight: 600; }
.row-slim .bar { flex: 2; height: 6px; background: var(--border-light); border-radius: 999px; overflow: hidden; margin: 0 8px; }
.row-slim .bar span { display: block; height: 100%; background: var(--accent-orange); transition: width 0.3s; }
.row-slim .note { flex: 1; text-align: right; font-size: 12px; color: var(--text-muted); }

/* BOUTONS */
.btn { background: var(--primary); color: #fff; border: none; border-radius: 8px; padding: 8px 12px; font-size: 14px; cursor: pointer; transition: background 0.2s; }
.btn:hover { background: var(--primary-dark); }
.btn.alt { background: var(--border-light); color: var(--text-main); }
.btn.alt:hover { background: #d1d5db; }
.btn.warn { background: #dc2626; }
.btn.warn:hover { background: #b91c1c; }
.btn.small { padding: 6px 10px; font-size: 12px; }
.btn-round { width: 56px; height: 56px; border-radius: 50%; border: 2px solid var(--border-light); background: #fff; cursor: pointer; font-size: 18px; font-weight: 900; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.btn-round:hover { background: var(--bg-light); }
.btn-round.btn-plus { background: var(--accent-green); color: #fff; border: none; }
.btn-plus:hover { background: #059669; }

/* COMPTEURS */
.count { font-size: 24px; font-weight: 900; }
.title { font-weight: 600; }

/* INPUTS */
input[type="text"], input[type="number"], input[type="checkbox"], input[type="file"], select { padding: 6px 8px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 14px; }
input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
input[type="number"] { width: 100%; }

/* SECTIONS */
.section-title { font-weight: 900; font-size: 14px; margin: 10px 0 8px; color: var(--primary); }

/* GRID */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.param { padding: 6px 0; }
.param label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 2px; }

/* TABS */
.tabs { display: flex; gap: 4px; padding: 8px; border-bottom: 1px solid var(--border-light); }
.tab { flex: 1; padding: 8px 6px; background: #fff; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
.tab.actif { background: var(--primary); color: #fff; border-color: var(--primary); }

/* NAV */
.nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid var(--border-light); display: flex; gap: 0; z-index: 50; max-width: 480px; margin: 0 auto; }
.nav button { flex: 1; background: none; border: none; padding: 8px 4px; cursor: pointer; font-size: 11px; font-weight: 600; color: var(--text-muted); transition: all 0.2s; border-top: 2px solid transparent; }
.nav button.actif { color: var(--primary); border-top-color: var(--primary); }
.nav .ico { display: block; font-size: 20px; margin-bottom: 2px; }

/* MODALES */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 50; }
.modal.show { display: flex; align-items: flex-end; justify-content: center; }
.sheet { background: #fff; width: 100%; max-width: 480px; border-radius: 16px 16px 0 0; padding: 14px; max-height: 80vh; overflow-y: auto; }
.sheet h3 { margin: 0 0 10px; font-size: 16px; }

/* GRAPHIQUES */
#stats-charts { margin-top: 12px; }
.chart-block { margin: 10px 0; }
.chart-caption { font-weight: 600; margin: 8px 0 4px; font-size: 1rem; }
canvas { width: 100%; height: auto; display: block; }
.chart-legend { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.9rem; }
.legend-item { display: flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: var(--bg-light); border: 1px solid var(--border-light); cursor: pointer; user-select: none; }
.legend-item.is-muted { opacity: 0.45; text-decoration: line-through; }
.legend-swatch { width: 14px; height: 3px; border-radius: 2px; display: inline-block; }
.chart-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px; flex-wrap: wrap; }
.chart-actions .btn { flex: 1; min-width: 140px; font-size: 12px; padding: 8px 10px; }

/* SNACKBAR */
.snackbar { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 13px; max-width: 90%; text-align: center; opacity: 0; transition: opacity 0.3s; z-index: 40; }
.snackbar.show { opacity: 1; }

@media (max-width: 480px) {
  .card, .banner { margin: 6px; padding: 12px; }
  .hdr { padding: 12px 8px; }
  .grid-2 { grid-template-columns: 1fr; }
}
  </style>
</head>
<body>

<div class="app-shell">
  <!-- HEADER -->
  <div class="hdr">
    <div class="title">üö≠ StopAddict v3</div>
    <div class="subtitle" id="date-actuelle">‚Äî</div>
  </div>

  <!-- ACCUEIL -->
  <div class="ecran show" id="ecran-accueil">
    <div class="card">
      <div class="row">
        <div class="title">üö¨ Clopes</div>
        <div class="count" id="compteur-clopes">0</div>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <button class="btn-round btn-minus" id="btn-clopes-moins" type="button">‚àí</button>
        <button class="btn-round btn-plus" id="btn-clopes-plus" type="button">+</button>
      </div>
    </div>

    <div class="card bar-green">
      <div class="row">
        <div class="title">üåø P√©tards</div>
        <div class="count" id="compteur-joints">0</div>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <button class="btn-round btn-minus" id="btn-joints-moins" type="button">‚àí</button>
        <button class="btn-round btn-plus" id="btn-joints-plus" type="button">+</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="title">üç∫ Alcool</div>
        <div class="count" id="compteur-alcool-total">0</div>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <button class="btn-round btn-minus" id="btn-alc-moins" type="button">‚àí</button>
        <button class="btn-round btn-plus" id="btn-alc-plus" type="button">+</button>
      </div>
    </div>

    <div class="banner orange">
      <div style="font-weight: 900; margin-bottom: 8px;" id="hello-accueil">‚Äî</div>
      <div class="row-slim">
        <div class="label">Clopes</div>
        <div class="bar"><span id="bar-clopes"></span></div>
        <div id="note-clopes" class="note">‚Äî</div>
      </div>
      <div class="row-slim">
        <div class="label">P√©tards</div>
        <div class="bar"><span id="bar-joints"></span></div>
        <div id="note-joints" class="note">‚Äî</div>
      </div>
      <div class="row-slim" id="row-alcool" style="display: none;">
        <div class="label">Alcool</div>
        <div class="bar"><span id="bar-alcool"></span></div>
        <div id="note-alcool" class="note">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- STATS -->
  <div class="ecran" id="ecran-stats">
    <div class="tabs" role="tablist">
      <button class="tab actif" data-vue="jour" type="button">Jour</button>
      <button class="tab" data-vue="semaine" type="button">Semaine</button>
      <button class="tab" data-vue="mois" type="button">Mois</button>
      <button class="tab" data-vue="annee" type="button">Ann√©e</button>
    </div>

    <div class="banner green">
      <div style="font-weight: 900; margin-bottom: 8px;" id="hello-stats">‚Äî</div>
      <div class="row-slim">
        <div class="label">Clopes</div>
        <div class="bar"><span id="bar-clopes-periode"></span></div>
        <div id="note-clopes-periode" class="note">‚Äî</div>
      </div>
      <div class="row-slim">
        <div class="label">P√©tards</div>
        <div class="bar"><span id="bar-joints-periode"></span></div>
        <div id="note-joints-periode" class="note">‚Äî</div>
      </div>
      <div class="row-slim" id="row-alcool-periode" style="display: none;">
        <div class="label">Alcool</div>
        <div class="bar"><span id="bar-alcool-periode"></span></div>
        <div id="note-alcool-periode" class="note">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">Graphiques</div>
      <div class="chart-legend" id="chart-legend"></div>
      <div class="chart-block">
        <div class="chart-caption">Consommations (unit√©s)</div>
        <canvas id="chart-consommations" width="960" height="260"></canvas>
      </div>
      <div class="chart-block">
        <div class="chart-caption">Co√ªt & √âconomies (‚Ç¨)</div>
        <canvas id="chart-cout-eco" width="960" height="260"></canvas>
      </div>
      <div class="chart-actions" id="chart-actions"></div>
    </div>
  </div>

  <!-- CALENDRIER -->
  <div class="ecran" id="ecran-calendrier">
    <div class="card">
      <div style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center; justify-content: space-between;">
        <button class="btn small" id="cal-prev" type="button">‚óÄ</button>
        <div style="font-weight: 900; flex: 1; text-align: center;" id="cal-titre">‚Äî</div>
        <button class="btn small" id="cal-next" type="button">‚ñ∂</button>
      </div>
      <div style="color: var(--text-muted); text-align: center; padding: 20px;">Calendrier (en construction)</div>
    </div>
  </div>

  <!-- HABITUDES -->
  <div class="ecran" id="ecran-habitudes">
    <div class="card">
      <div class="section-title">‚öôÔ∏è Limites Consommation/Jour</div>
      <div class="grid-2">
        <div class="param">
          <label for="max-clopes">Max Clopes</label>
          <input type="number" id="max-clopes" value="20">
        </div>
        <div class="param">
          <label for="max-joints">Max Joints</label>
          <input type="number" id="max-joints" value="3">
        </div>
        <div class="param">
          <label for="max-alcool">Max Alcool</label>
          <input type="number" id="max-alcool" value="2">
        </div>
      </div>
      <button class="btn small" id="btn-save-hab" type="button" style="margin-top: 8px;">Enregistrer</button>
    </div>
  </div>

  <!-- R√âGLAGES -->
  <div class="ecran" id="ecran-params">
    <div class="card">
      <div class="section-title">üí∞ Prix Unitaires (‚Ç¨)</div>
      <div class="grid-2">
        <div class="param">
          <label for="prix-paquet">Paquet</label>
          <input type="number" step="0.01" id="prix-paquet" value="11.00">
        </div>
        <div class="param">
          <label for="prix-joint">Joint</label>
          <input type="number" step="0.01" id="prix-joint" value="5.00">
        </div>
        <div class="param">
          <label for="prix-biere">Bi√®re</label>
          <input type="number" step="0.01" id="prix-biere" value="2.50">
        </div>
        <div class="param">
          <label for="prix-fort">Alcool Fort</label>
          <input type="number" step="0.01" id="prix-fort" value="3.00">
        </div>
      </div>
      <button class="btn small" id="btn-save-params" type="button" style="margin-top: 8px;">Enregistrer</button>
    </div>

    <div class="card">
      <div class="section-title">üîß Export / Import</div>
      <div class="grid-2">
        <button class="btn small" id="btn-export-csv" type="button">Exporter CSV</button>
        <button class="btn small" id="btn-export-json" type="button">Exporter JSON</button>
      </div>
      <div style="margin-top: 8px;">
        <button class="btn small alt" id="btn-import-json" type="button">Importer JSON</button>
        <input id="input-import-json" type="file" accept=".json" style="display: none;">
      </div>
    </div>

    <div class="card">
      <div class="section-title">üßπ Danger Zone</div>
      <div class="grid-2">
        <button class="btn small warn" id="btn-raz-jour" type="button">RAZ Jour</button>
        <button class="btn small warn" id="btn-raz-histo" type="button">RAZ Historique</button>
      </div>
    </div>
  </div>
</div>

<!-- SNACKBAR -->
<div class="snackbar" id="snackbar"></div>

<!-- NAV BOTTOM -->
<div class="nav">
  <button data-screen="accueil" class="actif" type="button"><span class="ico">üè†</span>Accueil</button>
  <button data-screen="stats" type="button"><span class="ico">üìä</span>Stats</button>
  <button data-screen="calendrier" type="button"><span class="ico">üìÖ</span>Calendrier</button>
  <button data-screen="habitudes" type="button"><span class="ico">‚öôÔ∏è</span>Habitudes</button>
  <button data-screen="params" type="button"><span class="ico">‚öôÔ∏è</span>R√©glages</button>
</div>

<script>
/* ========================================================================
   STOPADDICT v3 COMPLETE - REFACTORIS√â AVEC ALL FEATURES
   ======================================================================== */

console.log('[STOPADDICT v3 COMPLETE] D√©marrage...');

// ============================================================================
// SECTION 1 : STORAGE ET STATE
// ============================================================================

const K_DONNEES = 'app_donnees_v23';
const K_PARAMS = 'app_parametres_v23';
const K_HAB = 'app_habitudes_v23';
const K_VUE = 'app_vue_stats_v23';

let prenomUtilisateur = '';
let vueStats = 'jour';
let donnees = {};
let params = {};
let habitudes = {};
let derniereAction = null;

function loadState() {
  try {
    donnees = JSON.parse(localStorage.getItem(K_DONNEES) || '{}') || {};
    params = JSON.parse(localStorage.getItem(K_PARAMS) || '{}') || {};
    habitudes = JSON.parse(localStorage.getItem(K_HAB) || '{}') || {};
    vueStats = localStorage.getItem(K_VUE) || 'jour';
    console.log('[LOAD] √âtat charg√©');
  } catch (e) {
    console.error('[LOAD] Erreur :', e);
    donnees = {};
    params = {};
    habitudes = {};
  }
}

function persist() {
  try {
    localStorage.setItem(K_DONNEES, JSON.stringify(donnees));
    localStorage.setItem(K_PARAMS, JSON.stringify(params));
    localStorage.setItem(K_HAB, JSON.stringify(habitudes));
    localStorage.setItem(K_VUE, vueStats);
  } catch (e) {
    console.error('[PERSIST] Erreur :', e);
  }
}

// ============================================================================
// SECTION 2 : HELPERS
// ============================================================================

function byId(id) { return document.getElementById(id); }
function setText(id, txt) { const el = byId(id); if (el) el.textContent = txt; }
function setHTML(id, html) { const el = byId(id); if (el) el.innerHTML = html; }

function showSnackbar(msg = 'Action enregistr√©e') {
  const el = byId('snackbar');
  if (el) {
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
  }
}

function goto(screen) {
  try {
    document.querySelectorAll('.ecran').forEach(e => e.classList.remove('show'));
    const el = byId('ecran-' + screen);
    if (el) el.classList.add('show');
    
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('actif'));
    const navBtn = document.querySelector(`.nav button[data-screen="${screen}"]`);
    if (navBtn) navBtn.classList.add('actif');
    
    console.log('[GOTO] Navigation vers:', screen);
  } catch (e) {
    console.error('[GOTO] Erreur :', e);
  }
}

// ============================================================================
// SECTION 3 : DATE HELPERS
// ============================================================================

function keyLocal(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function getJour(dateStr = null) {
  if (!dateStr) dateStr = keyLocal(new Date());
  if (!donnees[dateStr]) donnees[dateStr] = {};
  return donnees[dateStr];
}

// ============================================================================
// SECTION 4 : CO√õTS
// ============================================================================

function calculerCoutJour(jour) {
  if (!jour) return 0;
  const coutClope = (params.prix_paquet || 11) / 20;
  const coutJoint = params.prix_joint || 5;
  const coutBiere = params.prix_biere || 2.5;
  const coutFort = params.prix_fort || 3;
  
  return (jour.cl_class || 0) * coutClope +
         (jour.cl_roul || 0) * coutClope +
         (jour.cl_tube || 0) * coutClope +
         (jour.joints || 0) * coutJoint +
         (jour.alc_biere || 0) * coutBiere +
         (jour.alc_fort || 0) * coutFort +
         (jour.alc_liqueur || 0) * (params.prix_liqueur || 2.8);
}

function referenceParJourPourDate(d) {
  try {
    const lim = (params.limite_clopes || 0) + (params.limite_joints || 0) + (params.limite_alcool || 0);
    if (lim <= 0) return null;
    
    const coutClope = (params.prix_paquet || 11) / 20;
    const coutJoint = params.prix_joint || 5;
    const coutAlc = params.prix_biere || 2.5;
    
    return (params.limite_clopes || 0) * coutClope +
           (params.limite_joints || 0) * coutJoint +
           (params.limite_alcool || 0) * coutAlc;
  } catch (e) {
    console.error('[REF] Erreur :', e);
    return null;
  }
}

// ============================================================================
// SECTION 5 : GRAPHIQUES
// ============================================================================

window.StopAddictCharts = window.StopAddictCharts || {};
window.StopAddictChartsState = { visible: { clopes: true, joints: true, alcool: true, cout: true, economies: true } };

function buildSeriesForCurrentView() {
  try {
    const now = new Date();
    const view = window.vueStats || 'jour';
    const labels = [];
    const C = [], J = [], A = [], CO = [], EC = [];

    if (view === 'jour') {
      const k = keyLocal(now);
      const j = getJour(k);
      labels.push('Aujourd'hui');
      C.push((j.cl_class || 0) + (j.cl_roul || 0) + (j.cl_tube || 0));
      J.push(j.joints || 0);
      A.push((j.alc_biere || 0) + (j.alc_fort || 0) + (j.alc_liqueur || 0));
      const cout = calculerCoutJour(j);
      CO.push(+cout.toFixed(2));
      const ref = referenceParJourPourDate(now);
      EC.push(ref ? Math.max(+ref - cout, 0).toFixed(2) : 0);
    } else if (view === 'semaine') {
      const d1 = new Date(now);
      d1.setDate(now.getDate() - (now.getDay() + 6) % 7);
      d1.setHours(0, 0, 0, 0);
      for (let i = 0; i < 7; i++) {
        const d = new Date(d1);
        d.setDate(d1.getDate() + i);
        const k = keyLocal(d);
        const j = getJour(k);
        labels.push(['Lu','Ma','Me','Je','Ve','Sa','Di'][(d.getDay()+6)%7]);
        C.push((j.cl_class || 0) + (j.cl_roul || 0) + (j.cl_tube || 0));
        J.push(j.joints || 0);
        A.push((j.alc_biere || 0) + (j.alc_fort || 0) + (j.alc_liqueur || 0));
        const cout = calculerCoutJour(j);
        CO.push(+cout.toFixed(2));
        const ref = referenceParJourPourDate(d);
        EC.push(ref ? Math.max(+ref - cout, 0).toFixed(2) : 0);
      }
    } else if (view === 'mois') {
      const y = now.getFullYear();
      const m = now.getMonth();
      const d2 = new Date(y, m + 1, 0);
      for (let day = 1; day <= d2.getDate(); day++) {
        const d = new Date(y, m, day);
        const k = keyLocal(d);
        const j = getJour(k);
        labels.push(String(day));
        C.push((j.cl_class || 0) + (j.cl_roul || 0) + (j.cl_tube || 0));
        J.push(j.joints || 0);
        A.push((j.alc_biere || 0) + (j.alc_fort || 0) + (j.alc_liqueur || 0));
        const cout = calculerCoutJour(j);
        CO.push(+cout.toFixed(2));
        const ref = referenceParJourPourDate(d);
        EC.push(ref ? Math.max(+ref - cout, 0).toFixed(2) : 0);
      }
    } else {
      const y = now.getFullYear();
      for (let m = 0; m < 12; m++) {
        const monthNames = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
        labels.push(monthNames[m]);
        let c = 0, j = 0, a = 0, co = 0, ec = 0;
        const d2 = new Date(y, m + 1, 0);
        for (let day = 1; day <= d2.getDate(); day++) {
          const d = new Date(y, m, day);
          const k = keyLocal(d);
          const jour = getJour(k);
          c += (jour.cl_class || 0) + (jour.cl_roul || 0) + (jour.cl_tube || 0);
          j += jour.joints || 0;
          a += (jour.alc_biere || 0) + (jour.alc_fort || 0) + (jour.alc_liqueur || 0);
          const cout = calculerCoutJour(jour);
          co += cout;
          const ref = referenceParJourPourDate(d);
          if (ref) ec += Math.max(+ref - cout, 0);
        }
        C.push(c);
        J.push(j);
        A.push(a);
        CO.push(+co.toFixed(2));
        EC.push(+ec.toFixed(2));
      }
    }

    return { labels, consos: { clopes: C, joints: J, alcool: A }, cout: CO, economies: EC };
  } catch (e) {
    console.error('[BUILD_SERIES] Erreur :', e);
    return null;
  }
}

window.StopAddictCharts.buildSeriesForCurrentView = buildSeriesForCurrentView;

function drawLineChart(canvas, cfg) {
  try {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(340, Math.round(rect.width * dpr));
    canvas.height = 260 * dpr;
    
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    
    const W = rect.width;
    const H = 260;
    const PAD = { l: 44, r: 10, t: 12, b: 26 };
    const X0 = PAD.l, X1 = W - PAD.r, Y0 = H - PAD.b, Y1 = PAD.t;
    
    ctx.clearRect(0, 0, W, H);
    
    const labels = cfg.labels || [];
    const series = (cfg.series || []).filter(s => s && s.visible !== false && s.data && s.data.length === labels.length);
    
    const yMax = Math.max(1, ...series.map(s => s.data.reduce((m, v) => Math.max(m, +v || 0), 0)));
    const steps = [1, 2, 5];
    const pow = Math.pow(10, Math.floor(Math.log10(yMax || 1)));
    let yStep = (steps.find(s => (s * pow) >= yMax / 4) || 1) * pow;
    const yAxisMax = Math.ceil(yMax / yStep) * yStep;
    
    const n = Math.max(1, labels.length - 1);
    const xAt = i => (n === 0 ? (X0 + X1) / 2 : X0 + (i * (X1 - X0) / n));
    const yAt = v => Y0 - ((v / (yAxisMax || 1)) * (Y0 - Y1));
    
    // Grille Y
    ctx.strokeStyle = '#e5e7eb';
    ctx.fillStyle = '#6b7280';
    ctx.lineWidth = 1;
    ctx.font = '12px system-ui';
    for (let y = 0; y <= yAxisMax; y += yStep) {
      const yy = yAt(y);
      ctx.beginPath();
      ctx.moveTo(X0, yy);
      ctx.lineTo(X1, yy);
      ctx.stroke();
      ctx.fillText(cfg.yFmt ? cfg.yFmt(y) : String(y), 4, yy - 2);
    }
    
    // Labels X
    const maxX = Math.min(6, labels.length);
    const stepX = Math.max(1, Math.floor(labels.length / maxX));
    ctx.fillStyle = '#374151';
    for (let i = 0; i < labels.length; i += stepX) {
      ctx.fillText(labels[i], xAt(i) - 8, H - 6);
    }
    
    // Courbes
    ctx.lineWidth = 2.4;
    for (const s of series) {
      ctx.strokeStyle = s.color || '#111';
      ctx.beginPath();
      for (let i = 0; i < labels.length; i++) {
        const x = xAt(i);
        const y = yAt(+s.data[i] || 0);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();
    }
  } catch (e) {
    console.error('[DRAW_CHART] Erreur :', e);
  }
}

function renderCharts() {
  try {
    const NS = window.StopAddictCharts;
    if (!NS) return;
    
    const data = NS.buildSeriesForCurrentView?.();
    if (!data) return;
    
    const vis = window.StopAddictChartsState.visible;
    const COLORS = { clopes: '#6b7280', joints: '#10b981', alcool: '#f59e0b', cout: '#7c3aed', economies: '#2563eb' };
    
    const c1 = byId('chart-consommations');
    const c2 = byId('chart-cout-eco');
    
    const hasPos = a => Array.isArray(a) && a.some(v => (+v || 0) > 0);
    
    if (c1) {
      const show1 = hasPos(data.consos?.clopes) || hasPos(data.consos?.joints) || hasPos(data.consos?.alcool);
      c1.hidden = !show1;
      if (show1) {
        drawLineChart(c1, {
          labels: data.labels,
          yFmt: v => String(Math.round(v)),
          series: [
            { data: data.consos.clopes, color: COLORS.clopes, visible: vis.clopes !== false },
            { data: data.consos.joints, color: COLORS.joints, visible: vis.joints !== false },
            { data: data.consos.alcool, color: COLORS.alcool, visible: vis.alcool !== false },
          ]
        });
      }
    }
    
    if (c2) {
      const show2 = hasPos(data.cout) || hasPos(data.economies);
      c2.hidden = !show2;
      if (show2) {
        const maxCost = data.cout.reduce((m, v) => Math.max(m, +v || 0), 0);
        const fmt = maxCost < 100
          ? new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 2 })
          : new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
        
        drawLineChart(c2, {
          labels: data.labels,
          yFmt: v => fmt.format(v),
          series: [
            { data: data.cout, color: COLORS.cout, visible: vis.cout !== false },
            { data: data.economies, color: COLORS.economies, visible: vis.economies !== false },
          ]
        });
      }
    }
    
    // L√©gende
    const box = byId('chart-legend');
    if (box) {
      box.innerHTML = '';
      const items = [
        { k: 'clopes', l: 'Clopes', c: COLORS.clopes, p: hasPos(data.consos?.clopes) },
        { k: 'joints', l: 'P√©tards', c: COLORS.joints, p: hasPos(data.consos?.joints) },
        { k: 'alcool', l: 'Alcool', c: COLORS.alcool, p: hasPos(data.consos?.alcool) },
        { k: 'cout', l: 'Co√ªt', c: COLORS.cout, p: hasPos(data.cout) },
        { k: 'economies', l: '√âconomies', c: COLORS.economies, p: hasPos(data.economies) },
      ];
      
      items.forEach(s => {
        const it = document.createElement('div');
        it.className = 'legend-item' + ((vis[s.k] === false) ? ' is-muted' : '') + (s.p ? '' : ' is-disabled');
        
        const sw = document.createElement('span');
        sw.className = 'legend-swatch';
        sw.style.background = s.c;
        
        const lb = document.createElement('span');
        lb.textContent = s.l;
        
        it.appendChild(sw);
        it.appendChild(lb);
        
        it.addEventListener('click', () => {
          if (!s.p) return;
          vis[s.k] = !(vis[s.k] !== false);
          it.classList.toggle('is-muted', vis[s.k] === false);
          renderCharts();
        });
        
        box.appendChild(it);
      });
    }
  } catch (e) {
    console.error('[RENDER] Erreur :', e);
  }
}

// ============================================================================
// SECTION 6 : UI UPDATES
// ============================================================================

function updateAllUI() {
  try {
    const now = new Date();
    const k = keyLocal(now);
    const j = getJour(k);
    
    const totC = (j.cl_class || 0) + (j.cl_roul || 0) + (j.cl_tube || 0);
    const totA = (j.alc_biere || 0) + (j.alc_fort || 0) + (j.alc_liqueur || 0);
    setText('compteur-clopes', String(totC));
    setText('compteur-joints', String(j.joints || 0));
    setText('compteur-alcool-total', String(totA));
    
    const maxC = Math.max(1, params.limite_clopes || 20);
    const maxJ = Math.max(1, params.limite_joints || 3);
    const maxA = Math.max(1, params.limite_alcool || 2);
    
    const pC = Math.min(100, (totC / maxC) * 100);
    const pJ = Math.min(100, (j.joints || 0) / maxJ * 100);
    const pA = Math.min(100, totA / maxA * 100);
    
    const barClopes = byId('bar-clopes');
    if (barClopes) barClopes.style.width = pC + '%';
    setText('note-clopes', totC + '/' + maxC);
    
    const barJoints = byId('bar-joints');
    if (barJoints) barJoints.style.width = pJ + '%';
    setText('note-joints', (j.joints || 0) + '/' + maxJ);
    
    byId('row-alcool').style.display = 'block';
    const barAlcool = byId('bar-alcool');
    if (barAlcool) barAlcool.style.width = pA + '%';
    setText('note-alcool', totA + '/' + maxA);
    
    setText('date-actuelle', now.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
    
    if (vueStats) renderCharts();
  } catch (e) {
    console.error('[UPDATE] Erreur :', e);
  }
}

// ============================================================================
// SECTION 7 : ACTIONS
// ============================================================================

function addConso(group, subtype, delta = 1) {
  try {
    const now = new Date();
    const k = keyLocal(now);
    const j = getJour(k);
    
    const old = j[group] || 0;
    const newVal = Math.max(0, old + delta);
    j[group] = newVal;
    
    derniereAction = { group, subtype, delta, date: k };
    persist();
    updateAllUI();
    showSnackbar(`+1 ${subtype}`);
  } catch (e) {
    console.error('[ADD] Erreur :', e);
  }
}

// ============================================================================
// SECTION 8 : EXPORT / IMPORT
// ============================================================================

function exportCSV() {
  try {
    const rows = [['date', 'cl_class', 'cl_roul', 'cl_tube', 'joints', 'alc_biere', 'alc_fort', 'alc_liqueur', 'cout']];
    
    Object.keys(donnees).sort().forEach(k => {
      const d = donnees[k] || {};
      const cout = calculerCoutJour(d).toFixed(2);
      rows.push([k, d.cl_class || 0, d.cl_roul || 0, d.cl_tube || 0, d.joints || 0, d.alc_biere || 0, d.alc_fort || 0, d.alc_liqueur || 0, cout]);
    });
    
    const csv = '\uFEFF' + rows.map(r => r.join(';')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'stopaddict_export.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    
    showSnackbar('CSV export√©');
  } catch (e) {
    console.error('[EXPORT_CSV] Erreur :', e);
    alert('Erreur export: ' + e.message);
  }
}

function exportJSON() {
  try {
    const data = { donnees, params, habitudes, prenom: prenomUtilisateur };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'stopaddict_backup.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    
    showSnackbar('JSON export√©');
  } catch (e) {
    console.error('[EXPORT_JSON] Erreur :', e);
    alert('Erreur export: ' + e.message);
  }
}

function importJSON(file) {
  try {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const txt = ev.target.result;
      const data = JSON.parse(txt);
      
      if (data.donnees) donnees = data.donnees;
      if (data.params) params = data.params;
      if (data.habitudes) habitudes = data.habitudes;
      if (data.prenom) prenomUtilisateur = data.prenom;
      
      persist();
      updateAllUI();
      showSnackbar('JSON import√©');
    };
    reader.readAsText(file);
  } catch (e) {
    console.error('[IMPORT_JSON] Erreur :', e);
    alert('Erreur import: ' + e.message);
  }
}

// ============================================================================
// SECTION 9 : INIT
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
  try {
    console.log('[INIT] Chargement...');
    
    loadState();
    
    // Params par d√©faut
    if (!params.prix_paquet) {
      params = {
        prix_paquet: 11.00,
        prix_joint: 5.00,
        prix_biere: 2.50,
        prix_fort: 3.00,
        prix_liqueur: 2.80,
        limite_clopes: 20,
        limite_joints: 3,
        limite_alcool: 2
      };
      persist();
    }
    
    // Sync UI params
    byId('prix-paquet').value = params.prix_paquet || 11;
    byId('prix-joint').value = params.prix_joint || 5;
    byId('prix-biere').value = params.prix_biere || 2.5;
    byId('prix-fort').value = params.prix_fort || 3;
    byId('max-clopes').value = params.limite_clopes || 20;
    byId('max-joints').value = params.limite_joints || 3;
    byId('max-alcool').value = params.limite_alcool || 2;
    
    // ==================== EVENT LISTENERS ====================
    
    // Compteurs
    byId('btn-clopes-plus')?.addEventListener('click', () => addConso('cl_class', 'clope', 1));
    byId('btn-clopes-moins')?.addEventListener('click', () => addConso('cl_class', 'clope', -1));
    byId('btn-joints-plus')?.addEventListener('click', () => addConso('joints', 'p√©tard', 1));
    byId('btn-joints-moins')?.addEventListener('click', () => addConso('joints', 'p√©tard', -1));
    byId('btn-alc-plus')?.addEventListener('click', () => addConso('alc_biere', 'alcool', 1));
    byId('btn-alc-moins')?.addEventListener('click', () => addConso('alc_biere', 'alcool', -1));
    
    // Tabs stats
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const vue = tab.dataset.vue;
        if (vue) {
          vueStats = vue;
          persist();
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('actif'));
          tab.classList.add('actif');
          updateAllUI();
        }
      });
    });
    
    // Nav buttons
    document.querySelectorAll('.nav button[data-screen]').forEach(btn => {
      btn.addEventListener('click', () => {
        const screen = btn.getAttribute('data-screen');
        if (screen) goto(screen);
      });
    });
    
    // Save params
    byId('btn-save-params')?.addEventListener('click', () => {
      params.prix_paquet = parseFloat(byId('prix-paquet').value) || 11;
      params.prix_joint = parseFloat(byId('prix-joint').value) || 5;
      params.prix_biere = parseFloat(byId('prix-biere').value) || 2.5;
      params.prix_fort = parseFloat(byId('prix-fort').value) || 3;
      persist();
      updateAllUI();
      showSnackbar('Prix enregistr√©s');
    });
    
    // Save habitudes
    byId('btn-save-hab')?.addEventListener('click', () => {
      params.limite_clopes = parseInt(byId('max-clopes').value) || 20;
      params.limite_joints = parseInt(byId('max-joints').value) || 3;
      params.limite_alcool = parseInt(byId('max-alcool').value) || 2;
      persist();
      updateAllUI();
      showSnackbar('Limites enregistr√©es');
    });
    
    // Export / Import
    byId('btn-export-csv')?.addEventListener('click', exportCSV);
    byId('btn-export-json')?.addEventListener('click', exportJSON);
    byId('btn-import-json')?.addEventListener('click', () => byId('input-import-json')?.click());
    byId('input-import-json')?.addEventListener('change', (ev) => {
      const file = ev.target.files?.[0];
      if (file) importJSON(file);
    });
    
    // RAZ
    byId('btn-raz-jour')?.addEventListener('click', () => {
      if (confirm('Effacer le jour actuel ?')) {
        const k = keyLocal(new Date());
        donnees[k] = {};
        persist();
        updateAllUI();
        showSnackbar('Jour effac√©');
      }
    });
    
    byId('btn-raz-histo')?.addEventListener('click', () => {
      if (confirm('Effacer TOUT l'historique ?')) {
        donnees = {};
        persist();
        updateAllUI();
        showSnackbar('Historique effac√©');
      }
    });
    
    // Boutons export vue dans chart-actions
    setTimeout(() => {
      const bar = byId('chart-actions');
      if (bar && bar.children.length === 0) {
        const btn1 = document.createElement('button');
        btn1.className = 'btn';
        btn1.textContent = 'Export Vue';
        btn1.addEventListener('click', () => {
          const s = window.StopAddictCharts.buildSeriesForCurrentView?.();
          if (!s || !s.labels) {
            alert('Aucune donn√©e');
            return;
          }
          const rows = [['label', 'clopes', 'joints', 'alcool', 'cout', 'eco']];
          for (let i = 0; i < s.labels.length; i++) {
            rows.push([s.labels[i], s.consos.clopes[i] || 0, s.consos.joints[i] || 0, s.consos.alcool[i] || 0, s.cout[i] || 0, s.economies[i] || 0]);
          }
          const csv = '\uFEFF' + rows.map(r => r.join(';')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'stopaddict_vue.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
        bar.appendChild(btn1);
      }
    }, 100);
    
    // Init UI
    updateAllUI();
    goto('accueil');
    
    console.log('[INIT] ‚úÖ Pr√™t - Tous les buttons wired');
  } catch (e) {
    console.error('[INIT] ‚ùå Erreur fatale :', e);
    alert('Erreur: ' + e.message);
  }
});
</script>

</body>
</html>
