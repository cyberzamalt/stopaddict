<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>StopAddict – Compteur Tabac, Cannabis & Alcool (v2.4.0 CLEAN)</title>
<meta name="application-name" content="StopAddict">
<meta name="apple-mobile-web-app-title" content="StopAddict">

<!-- CSP -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob:;
               img-src 'self' data: blob:;
               style-src 'self' 'unsafe-inline';
               script-src 'self' 'unsafe-inline';
               connect-src 'self';
               object-src 'none';
               base-uri 'none';
               form-action 'self'">

<style>
  :root{
    --bg1:#667eea; --bg2:#764ba2;
    --ink:#1f2937; --muted:#6b7280; --card:#ffffff;
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --info:#3b82f6;
    --chip:#f3f4f6; --divider:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--ink); background:linear-gradient(180deg,var(--bg1),var(--bg2));
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .container{max-width:460px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; background:#f8fafc; position:relative;}

  /* Header */
  .header{position:sticky; top:0; z-index:3; background:linear-gradient(135deg,#2c3e50,#34495e); color:#fff; padding:10px 14px; text-align:center}
  .brand{display:flex; align-items:center; gap:8px; justify-content:center; margin-bottom:2px}
  .brand img{width:24px; height:24px; border-radius:6px; object-fit:cover}
  .brand-name{font-weight:900; letter-spacing:.2px}
  .brand-ver{opacity:.8; font-size:12px; margin-left:4px}
  .date{font-weight:800; font-size:18px}
  .heure{opacity:.95; font-size:13px; margin-top:2px}

  .debug-console{position:fixed; top:0; left:0; right:0; background:rgba(0,0,0,.95); color:#b5f7b7; font:12px/1.35 ui-monospace, Menlo, monospace; padding:6px 8px; max-height:40vh; overflow:auto; z-index:9999; border-bottom:2px solid #34d399; display:none}
  .debug-console.show{display:block}

  /* Stats rapides (jour courant) */
  .stats-rapides{background:#fff; display:grid; grid-template-columns:repeat(4,1fr); gap:8px; padding:10px; border-bottom:1px solid var(--divider)}
  .stat-item{text-align:center; padding:6px}
  .stat-val{font-weight:900; font-size:20px; color:var(--ink)}
  .stat-lbl{font-size:11px; color:#6b7280; margin-top:2px}

  /* Bandeau KPIs (totaux & économies) utilisé par stats.js */
  .stats-header{background:#fff; display:grid; grid-template-columns:repeat(5,1fr); gap:8px; padding:8px 10px; border-bottom:1px solid var(--divider)}
  .kpi{background:#f9fafb; border:1px solid var(--divider); border-radius:10px; padding:6px; text-align:center}
  .kpi .kpi-val{font-weight:900; font-size:16px; color:#111827}
  .kpi .kpi-lbl{font-size:11px; color:#6b7280}

  .content{flex:1; padding:0 0 80px; overflow-y:auto}
  .ecran{display:none}
  .ecran.show{display:block; animation:fadeIn .2s ease}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}

  .card{background:#fff; border-radius:14px; margin:10px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .card.bar-left{border-left:4px solid var(--info)}
  .card.bar-left.green{border-left-color:var(--ok)}
  .card.bar-left.orange{border-left-color:var(--warn)}

  .banner{background:#fff; border-radius:14px; margin:10px; padding:12px; border:2px solid var(--divider)}
  .banner.green{background:#ecfdf5; border-color:#6ee7b7}
  .banner.orange{background:#fff7ed; border-color:#fdba74}
  .banner-title{font-weight:900; font-size:15px; margin-bottom:8px}

  .line{display:flex; justify-content:space-between; align-items:center; padding:4px 0}
  .lbl{font-weight:700; font-size:14px}
  .val{font-weight:900; font-size:18px; color:#111827}

  .segment{display:flex; gap:4px; margin:6px 0}
  .seg{flex:1; height:28px; border-radius:6px; background:#e5e7eb; border:2px solid transparent; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:11px; color:#6b7280; cursor:pointer; transition:all .15s ease}
  .seg.actif{background:#3b82f6; color:#fff; border-color:#2563eb}
  .seg:hover{transform:scale(1.05)}

  .pm{display:flex; gap:8px; justify-content:center; margin:8px 0}
  .btn-round{width:56px; height:56px; border-radius:50%; border:0; background:#f3f4f6; color:#111827; font-size:22px; font-weight:900; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .15s ease}
  .btn-round:hover{background:#e5e7eb; transform:scale(1.05)}
  .btn-round.btn-plus{background:var(--ok); color:#fff}
  .btn-round.btn-plus:hover{background:#16a34a}
  .btn-round.btn-minus{background:#f3f4f6; color:#6b7280}
  .btn-round.btn-minus:hover{background:#e5e7eb; color:#374151}

  .conseil{background:#fef3c7; border-left:4px solid var(--warn); padding:12px; border-radius:8px; margin:10px; font-size:14px; line-height:1.5}
  .adv-ctl{display:flex; align-items:center; gap:6px; justify-content:flex-end}
  .ctl{background:#fff; color:#111827; border-radius:8px; padding:4px 8px; text-decoration:none; font-weight:900; font-size:12px; cursor:pointer; border:0}
  .dots{font-size:12px; letter-spacing:3px; opacity:.85}

  .tabs{display:flex; gap:8px; margin-bottom:8px}
  .tab{flex:1; background:#e6fffa; border:2px solid #b2f5ea; color:#0f766e; border-radius:999px; padding:8px; font-weight:800; font-size:13px; text-align:center; cursor:pointer; transition:all .15s ease}
  .tab.actif{background:#3b82f6; border-color:#3b82f6; color:#fff}
  .tab:hover{transform:translateY(-2px)}

  .divider{height:1px; background:var(--divider); margin:10px 0}
  .stats-block{background:#fff; border-radius:12px; padding:14px}

  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center}
  .grid-2 .param{display:contents}
  .param label{font-size:13px; color:#374151; font-weight:700}
  .param input[type="number"], .param input[type="text"], .param input[type="date"]{width:100%; padding:8px 10px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; background:#f9fafb}
  .param input[type="checkbox"]{transform:scale(1.1); cursor:pointer}
  .param .hint{grid-column:1 / -1; font-size:12px; color:#6b7280}
  .section-title{font-weight:900; font-size:15px; color:#111827; border-bottom:2px solid #eef2f7; padding-bottom:6px; margin-bottom:10px}

  .nav{position:fixed; left:50%; transform:translateX(-50%); bottom:0; width:100%; max-width:460px; background:#fff; border-top:1px solid var(--divider); display:flex; z-index:10}
  .nav button{flex:1; background:transparent; border:0; padding:10px 6px 8px; color:#64748b; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:2px; cursor:pointer; transition:all .15s ease}
  .nav button.actif{color:#3b82f6; background:rgba(59,130,246,.06)}
  .nav .ico{font-size:18px}

  .snackbar{position:fixed; left:50%; transform:translateX(-50%) translateY(20px); bottom:76px; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px; display:none; gap:10px; align-items:center; z-index:60}
  .snackbar.show{display:flex; animation:fadeUp .2s ease}
  .snackbar a{color:#34d399; font-weight:900; text-decoration:none}
  @keyframes fadeUp{from{opacity:0; transform:translateX(-50%) translateY(40px)} to{opacity:1; transform:translateX(-50%) translateY(20px)}}

  .btn{background:#111827; color:#fff; border:0; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer; transition:all .15s ease}
  .btn:hover{background:#374151; transform:translateY(-1px)}
  .btn.alt{background:#374151}
  .btn.alt:hover{background:#4b5563}
  .btn.warn{background:#ef4444}
  .btn.warn:hover{background:#dc2626}
  .btn.small{padding:6px 10px; font-size:13px}
  .btn:disabled{opacity:.5; cursor:not-allowed; transform:none !important}

  .modal{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:flex-end; justify-content:center; z-index:50}
  .modal.show{display:flex; animation:slideUp .2s ease}
  @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
  .sheet{background:#fff; border-radius:20px 20px 0 0; padding:20px; max-height:80vh; overflow-y:auto; width:100%; max-width:460px}
  .sheet h3{margin:0 0 12px; font-size:16px; color:#111827}

  .warn-box{padding:12px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:8px; margin:10px 0}
  .warn-title{color:#d97706}
  .warn-list{margin:8px 0; padding-left:20px}
  .warn-list li{margin:4px 0; font-size:13px}
  .warn-note{font-size:12px; color:#6b7280}
  .warn-actions{display:flex; justify-content:space-between; align-items:flex-end; gap:8px; margin-top:12px}
  .warn-actions .right{display:flex; gap:8px}

  .pages-title{color:#111827}
  .page-content{font-size:13px; line-height:1.6; color:#374151}
  .page-content strong{color:#111827}
  .page-content a{color:#3b82f6; text-decoration:none}
  .page-content a:hover{text-decoration:underline}

  /* Chart containers */
  #chart-consommations, #chart-cout-eco {
    max-height: 300px;
    min-height: 250px;
  }

  /* Export buttons layout */
  #chart-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 10px;
  }
  #chart-actions .btn {
    width: 100%;
  }
</style>
</head>
<body>
<div class="container">
  <!-- ======================= HEADER ======================= -->
  <div class="header">
    <div class="brand">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%2322c55e' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='65' font-size='50' font-weight='bold' fill='white' text-anchor='middle'%3E🛑%3C/text%3E%3C/svg%3E" alt="StopAddict">
      <span class="brand-name">StopAddict</span>
      <span class="brand-ver">v2.4.4</span>
    </div>
    <div class="date" id="date-actuelle">—</div>
    <div class="heure" id="heure-actuelle">—</div>
  </div>

  <!-- ======================= DEBUG CONSOLE ======================= -->
  <div class="debug-console" id="debug-console"></div>

  <!-- ======================= CONTENU PRINCIPAL ======================= -->
  <div class="content">
    <!-- ÉCRAN ACCUEIL -->
    <div id="ecran-principal" class="ecran show">
      <!-- Stats rapides (jour courant) -->
      <div class="stats-rapides">
        <div class="stat-item">
          <div class="stat-val" id="bar-clopes">0</div>
          <div class="stat-lbl">Clopes</div>
        </div>
        <div class="stat-item">
          <div class="stat-val" id="bar-joints">0</div>
          <div class="stat-lbl">Joints</div>
        </div>
        <div class="stat-item">
          <div class="stat-val" id="bar-alcool">0</div>
          <div class="stat-lbl">Alcool</div>
        </div>
        <div class="stat-item">
          <div class="stat-val">0€</div>
          <div class="stat-lbl">Coût</div>
        </div>
      </div>

      <!-- Cartes des compteurs individuels -->
      <div class="card bar-left green" id="card-cigs">
        <div class="line">
          <span class="lbl">🚬 Cigarettes</span>
          <span class="val">0</span>
        </div>
        <div class="pm" aria-label="Actions cigarettes">
          <button class="btn-round btn-minus" id="cl-moins" type="button">−1</button>
          <button class="btn-round btn-plus" id="cl-plus" type="button">+1</button>
        </div>
      </div>

      <div class="card bar-left green" id="card-weed">
        <div class="line">
          <span class="lbl">🍃 Joints</span>
          <span class="val">0</span>
        </div>
        <div class="pm" aria-label="Actions joints">
          <button class="btn-round btn-minus" id="j-moins" type="button">−1</button>
          <button class="btn-round btn-plus" id="j-plus" type="button">+1</button>
        </div>
      </div>

      <div class="card bar-left green" id="card-alcool">
        <div class="line">
          <span class="lbl">🍺 Alcool</span>
          <span class="val">0</span>
        </div>
        <div class="pm" aria-label="Actions alcool">
          <button class="btn-round btn-minus" id="a-moins" type="button">−1</button>
          <button class="btn-round btn-plus" id="a-plus" type="button">+1</button>
        </div>
      </div>

      <div class="conseil">
        <strong>💡 Conseil du jour</strong><br>
        Chaque jour sans, c'est un pas vers ta meilleure version. Reste motivé(e) !
      </div>
    </div>

    <!-- ÉCRAN STATS -->
    <div id="ecran-stats" class="ecran" style="display:none;">
      <!-- Bannière Stats (Aujourd'hui / Semaine / Mois / Année) -->
      <div class="stats-header">
        <div class="kpi">
          <div class="kpi-val" id="stats-clopes">0</div>
          <div class="kpi-lbl">Clopes</div>
        </div>
        <div class="kpi">
          <div class="kpi-val" id="stats-joints">0</div>
          <div class="kpi-lbl">Joints</div>
        </div>
        <div class="kpi" id="stats-alcool-line">
          <div class="kpi-val" id="stats-alcool">0</div>
          <div class="kpi-lbl">Alcool</div>
        </div>
        <div class="kpi">
          <div class="kpi-val">0€</div>
          <div class="kpi-lbl">Coût</div>
        </div>
        <div class="kpi">
          <div class="kpi-val">0€</div>
          <div class="kpi-lbl">Économies</div>
        </div>
      </div>

      <!-- Titre Stats -->
      <div style="padding:10px; text-align:center; font-weight:900; font-size:16px; color:#111827;">
        <span id="stats-titre">Aujourd'hui</span>
      </div>

      <!-- Onglets Range (jour/semaine/mois/année) -->
      <div class="tabs" id="chartRange">
        <button class="tab active" data-range="day" type="button">Jour</button>
        <button class="tab" data-range="week" type="button">Semaine</button>
        <button class="tab" data-range="month" type="button">Mois</button>
        <button class="tab" data-range="year" type="button">Année</button>
      </div>

      <!-- Graphique Consommations -->
      <div class="card">
        <div style="font-weight:900; margin-bottom:8px;">Consommations (unités)</div>
        <canvas id="chart-consommations" width="400" height="300"></canvas>
      </div>

      <!-- Graphique Coût/Économies -->
      <div class="card">
        <div style="font-weight:900; margin-bottom:8px;">Coût / Économies</div>
        <canvas id="chart-cout-eco" width="400" height="300"></canvas>
      </div>

      <!-- Boutons d'export -->
      <div id="chart-actions" style="display:flex; flex-direction:column; gap:8px; padding:10px;">
        <button class="btn" type="button">Exporter historique complet (Excel)</button>
        <button class="btn alt" type="button">Exporter la vue actuelle</button>
        <button class="btn alt" type="button">Importer (CSV/JSON)</button>
      </div>
    </div>

    <!-- ÉCRAN CALENDRIER -->
    <div id="ecran-calendrier" class="ecran" style="display:none;">
      <div style="padding:20px; text-align:center; color:#999;">
        <div style="font-weight:900; margin-bottom:10px;">Calendrier</div>
        <div id="cal-grid" style="margin-top:10px;">
          <!-- Grille calendrier à venir (PHASE 3) -->
          <div style="color:#ccc;">Grille calendrier — à venir</div>
        </div>
      </div>
    </div>

    <!-- ÉCRAN HABITUDES -->
    <div id="ecran-habitudes" class="ecran" style="display:none;">
      <div class="card">
        <div class="section-title">⚙️ Habitudes & Consommations type</div>
        <div class="grid-2">
          <div class="param"><label>Cigarettes par jour</label><input type="number" min="0" id="hab-clopes-jour" value="0"></div>
          <div class="param"><label>Joints par jour</label><input type="number" min="0" id="hab-joints-jour" value="0"></div>
          <div class="param"><label>Bières par semaine</label><input type="number" min="0" id="hab-biere-sem" value="0"></div>
          <div class="param"><label>Alcool fort (doses)</label><input type="number" min="0" id="hab-alcool-fort" value="0"></div>
          <div class="param hint">Utilisées pour estimer les économies.</div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">💰 Prix Unitaires (optionnel)</div>
        <div class="grid-2">
          <div class="param"><label>Prix 1 paquet clopes (€)</label><input type="number" min="0" step="0.1" id="price-clopes" value="7.00"></div>
          <div class="param"><label>Prix 1 joint (€)</label><input type="number" min="0" step="0.1" id="price-joint" value="5.00"></div>
          <div class="param"><label>Prix 1 bière (€)</label><input type="number" min="0" step="0.1" id="price-biere" value="2.00"></div>
          <div class="param"><label>Prix 1 alcool fort (€)</label><input type="number" min="0" step="0.1" id="price-fort" value="10.00"></div>
          <div class="param hint">Utilisées pour calculer les économies estimées. Tout est optionnel.</div>
        </div>
        <button class="btn small" id="btn-save-hab" type="button" style="margin-top:10px">Enregistrer</button>
      </div>

      <div class="card">
        <div class="section-title">📅 Dates Clés</div>
        <div class="grid-2">
          <div class="param"><label>Réduction clopes</label><input type="date" id="date-reduc-clopes"></div>
          <div class="param"><label>Stop clopes</label><input type="date" id="date-stop-clopes"></div>
          <div class="param"><label>Objectif 0 clope</label><input type="date" id="date-no-clopes"></div>
          <div class="param"><label>Réduction joints</label><input type="date" id="date-reduc-joints"></div>
          <div class="param"><label>Stop joints</label><input type="date" id="date-stop-joints"></div>
          <div class="param"><label>Objectif 0 joint</label><input type="date" id="date-no-joints"></div>
          <div class="param"><label>Réduction alcool</label><input type="date" id="date-reduc-alcool"></div>
          <div class="param"><label>Stop alcool</label><input type="date" id="date-stop-alcool"></div>
          <div class="param"><label>Objectif 0 alcool</label><input type="date" id="date-no-alcool"></div>
          <div class="param hint">Optionnel. Apparaissent sur le calendrier.</div>
        </div>
      </div>
    </div>

    <!-- ÉCRAN RÉGLAGES -->
    <div id="ecran-params" class="ecran" style="display:none;">
      <p style="padding: 20px; text-align: center; color: #999;">Réglages</p>
    </div>
  </div>

  <!-- ======================= NAV ======================= -->
  <div class="nav">
    <button id="nav-principal" class="actif" type="button"><span class="ico">🏠</span>Accueil</button>
    <button id="nav-stats" type="button"><span class="ico">📊</span>Stats</button>
    <button id="nav-calendrier" type="button"><span class="ico">📅</span>Calendrier</button>
    <button id="nav-habitudes" type="button"><span class="ico">⚙️</span>Habitudes</button>
    <button id="nav-params" type="button"><span class="ico">⚙️</span>Réglages</button>
  </div>
</div>

<!-- ======================= MODALE CALENDRIER JOUR ======================= -->
<div class="modal" id="cal-jour" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <h3 id="cal-jour-titre">—</h3>

    <div class="line"><span class="lbl">Cigarettes</span> <span id="cal-jour-cl"></span></div>
    <div class="segment" id="cal-jour-seg-cl"></div>
    <div class="pm" aria-label="Actions cigarettes (jour)">
      <button class="btn-round btn-minus" id="cal-cl-moins" type="button">−1</button>
      <button class="btn-round btn-plus" id="cal-cl-plus" type="button">+1</button>
    </div>

    <div class="divider" style="margin:10px 0"></div>

    <div class="line"><span class="lbl">Joints</span> <span id="cal-jour-j"></span></div>
    <div class="pm" aria-label="Actions joints (jour)">
      <button class="btn-round btn-minus" id="cal-j-moins" type="button">−1</button>
      <button class="btn-round btn-plus" id="cal-j-plus" type="button">+1</button>
    </div>

    <div class="divider" style="margin:10px 0"></div>

    <div class="line"><span class="lbl">Alcool</span> <span id="cal-jour-a"></span></div>
    <div class="segment" id="cal-jour-seg-a"></div>
    <div class="pm" aria-label="Actions alcool (jour)">
      <button class="btn-round btn-minus" id="cal-a-moins" type="button">−1</button>
      <button class="btn-round btn-plus" id="cal-a-plus" type="button">+1</button>
    </div>

    <div style="display:flex; justify-content:space-between; margin-top:12px">
      <button class="btn alt" id="cal-jour-raz" type="button">RAZ du jour</button>
      <button class="btn" id="cal-jour-fermer" type="button">Fermer</button>
    </div>
  </div>
</div>

<!-- Snackbar -->
<div class="snackbar" id="snackbar">Action enregistrée — <a href="#" id="undo-link">Annuler</a></div>

<!-- ======================= MODALE AVERTISSEMENT (18+) ======================= -->
<div class="modal" id="modal-warn" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="warn-title">
    <h3 class="warn-title" id="warn-title">Avertissement – Public majeur (18+)</h3>
    <div class="warn-box">
      <p><strong>StopAddict</strong> est une application d'auto-suivi et d'aide à la réduction/arrêt des consommations (tabac, alcool, cannabis).</p>
      <ul class="warn-list">
        <li>Réservée aux personnes de 18 ans et plus.</li>
        <li>Ne fait pas la promotion de ces produits.</li>
        <li>Ne remplace pas un accompagnement médical, psychologique ou social. En cas de difficulté, consultez un professionnel.</li>
        <li>Utilisez StopAddict de façon responsable.</li>
      </ul>
      <p class="warn-note">Besoin d'aide ? <a href="#" id="open-ressources-from-warn">Ressources et numéros utiles</a></p>
      <div style="margin-top:8px">
        <label><input type="checkbox" id="chk-warn-18"> J'ai 18 ans ou plus</label><br>
        <label><input type="checkbox" id="chk-warn-hide"> Ne plus réafficher ce message</label>
      </div>
      <div class="warn-actions">
        <button class="btn warn" id="btn-warn-quit" type="button">Quitter</button>
        <div class="right">
          <button class="btn alt" id="btn-warn-cancel" type="button">Annuler</button>
          <button class="btn" id="btn-warn-accept" type="button" disabled>J'accepte et continuer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================= MODALE PAGES (Manuel / CGV / Mentions / Ressources) ======================= -->
<div class="modal" id="modal-page" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="page-title">
    <h3 class="pages-title" id="page-title">—</h3>
    <div class="page-content" id="page-content">
      <!-- Contenu injecté par JS -->
    </div>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
      <button class="btn alt" id="btn-page-close" type="button">Fermer</button>
    </div>
  </div>
</div>

<!-- ======================= SCRIPTS ======================= -->
<!-- Charger Chart.js AVANT app.js (PHASE 2 Option B) -->
<script src="./js/vendor/chart.umd.min.js"></script>
<!-- App.js importe et initialise le reste -->
<script type="module" src="./js/app.js"></script>
</body>
</html>
